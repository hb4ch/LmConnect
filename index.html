<!DOCTYPE html>
<html>
<head>
  <title>LMConnect</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 200px; padding: 20px; background: #f8f9fa; border-right: 1px solid #dee2e6; }
    .main { flex: 1; padding: 20px; overflow-y: auto; }
    .message { margin: 8px 0; padding: 12px; border-radius: 5px; }
    .user { background-color: #e9ecef; }
    .bot { background-color: #cce5ff; }
    .input-area { padding: 15px; background: #fff; position: fixed; bottom: 0; width: 100%; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); }
    input { width: calc(100% - 100px); padding: 10px; margin-right: 10px; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h3>API Provider</h3>
      <select id="api-select">
        <option value="openai">OpenAI</option>
        <option value="anthropic">Claude</option>
        <option value="google">Google</option>
        <option value="deepseek">DeepSeek</option>
      </select>
      <div class="api-key-input">
        <input type="text" id="api-key-input" placeholder="Enter API Key">
        <button onclick="saveAPIKey()">Save Key</button>
      </div>
    </div>
    <div class="main" id="chat-log"></div>
  </div>
  <div class="input-area">
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-btn">Send</button>
  </div>

  <script>
    const chatLog = document.getElementById('chat-log');
    const userInputElement = document.getElementById('user-input');

    // Save API Key function
    async function saveAPIKey() {
      const provider = document.getElementById('api-select').value;
      const key = document.getElementById('api-key-input').value;
      if (!provider || !key) return alert('Provider and key are required');
      await window.electronAPI.saveAPIKey(provider, key);
      alert('API Key saved!');
    }

    // Send message function
    async function sendMessage() {
      const message = userInputElement.value.trim();
      if (!message) return;

      // Add user message to UI
      const userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = 'You: ' + message;
      chatLog.appendChild(userMsg);
      userInputElement.value = '';
      chatLog.scrollTop = chatLog.scrollHeight;

      // Get selected provider and key
      const provider = document.getElementById('api-select').value;
      const apiKey = await window.electronAPI.getAPIKey(provider);
      if (!apiKey) return alert(`No API key saved for ${provider}`);

      // Simulate API call (replace with actual API logic later)
      const botResponse = await simulateAPIResponse(message, provider);
      displayBotMessage(botResponse);
    }

    // Send API Request function
    async function sendAPIRequest(provider, apiKey, message) {
      try {
        if (provider === 'openai') {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [{ role: 'user', content: message }],
              max_tokens: 150
            })
          });
          const data = await response.json();
          return data.choices[0].message.content;
        } else if (provider === 'anthropic') {
          const response = await fetch('https://api.anthropic.com/v1/complete', {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              prompt: `Human: ${message}\nAssistant:`,
              model: 'claude-3',
              max_tokens_to_sample: 300,
              stop_sequences: ['\nHuman:']
            })
          });
          const data = await response.json();
          return data.completion.trim();
        } else if (provider === 'google') {
          const model = 'gemini-pro';
          const endpoint = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`;
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                role: 'user',
                parts: [message]
              }],
              generationOptions: {
                temperature: 0.7,
                maxOutputTokens: 256
              }
            })
          });
          const data = await response.json();
          return data.results[0].replies[0].content.parts[0];
        } else if (provider === 'deepseek') {
          const response = await fetch('https://api.deepseek.cn/api/v1/chat', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: '6b',
              messages: [{ role: 'user', content: message }],
              temperature: 0.7
            })
          });
          const data = await response.json();
          return data.choices[0].message.content;
        }
      } catch (error) {
        console.error(`API Error for ${provider}:`, error);
        return `Error: ${error.message}`;
      }
    }

    // Send message function (updated)
    async function sendMessage() {
      const message = userInputElement.value.trim();
      if (!message) return;

      // Add user message to UI
      const userMsg = document.createElement('div');
      userMsg.className = 'message user';
      userMsg.textContent = 'You: ' + message;
      chatLog.appendChild(userMsg);
      userInputElement.value = '';
      chatLog.scrollTop = chatLog.scrollHeight;

      // Get selected provider and key
      const provider = document.getElementById('api-select').value;
      const apiKey = await window.electronAPI.getAPIKey(provider);
      if (!apiKey) return alert(`No API key saved for ${provider}`);

    // Call API and display response
    try {
      const botResponse = await sendAPIRequest(provider, apiKey, message);
      displayBotMessage(botResponse);
      // Log to database
      await window.electronAPI.logChatMessage(message, botResponse, provider);
    } catch (err) {
      displayBotMessage(`Error: ${err.message}`);
    }
    }

    function displayBotMessage(response) {
      const botMsg = document.createElement('div');
      botMsg.className = 'message bot';
      botMsg.textContent = `Bot: ${response}`;
      chatLog.appendChild(botMsg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Load chat history on startup
    (async () => {
      try {
        const history = await window.electronAPI.getChatHistory();
        history.forEach(entry => {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user';
          userMsg.textContent = `You: ${entry.user_message}`;
          chatLog.appendChild(userMsg);
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot';
          botMsg.textContent = `Bot: ${entry.bot_response}`;
          chatLog.appendChild(botMsg);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      } catch (err) {
        console.error('Error loading chat history:', err);
      }
    })();
    
    // Event listeners
    document.getElementById('send-btn').addEventListener('click', sendMessage);
  </script>
</body>
</html>
